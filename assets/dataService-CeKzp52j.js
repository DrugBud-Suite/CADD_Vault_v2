const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B7UqGdPd.js","assets/index-B7rZpWz0.css"])))=>i.map(i=>d[i]);
var G=Object.defineProperty;var H=(m,e,t)=>e in m?G(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var q=(m,e,t)=>H(m,typeof e!="symbol"?e+"":e,t);import{n as d,w as K}from"./index-B7UqGdPd.js";class W{constructor(e){q(this,"query");q(this,"countQuery");q(this,"table");this.table=e,this.query=d.from(e).select("*"),this.countQuery=d.from(e).select("*",{count:"exact",head:!0})}select(e){return this.query=d.from(this.table).select(e),this.countQuery=d.from(this.table).select("*",{count:"exact",head:!0}),this}filter(e,t,a){return this.query=this.query[t](e,a),this.countQuery=this.countQuery[t](e,a),this}filters(e){return e.forEach(({field:t,operator:a,value:r})=>{this.filter(t,a,r)}),this}search(e,t){return t&&(this.query=this.query.ilike(e,`%${t}%`),this.countQuery=this.countQuery.ilike(e,`%${t}%`)),this}paginate(e,t){const a=e*t,r=a+t-1;return this.query=this.query.range(a,r),this}orderBy(e,t="asc"){return this.query=this.query.order(e,{ascending:t==="asc"}),this}filterByFolder(e){return this.query=this.query.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name)))").eq("package_folder_categories.folder_categories.folders.name",e),this.countQuery=this.countQuery.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name)))",{count:"exact",head:!0}).eq("package_folder_categories.folder_categories.folders.name",e),this}filterByCategory(e){return this.query=this.query.select("*, package_folder_categories!inner(folder_categories!inner(categories!inner(name)))").eq("package_folder_categories.folder_categories.categories.name",e),this.countQuery=this.countQuery.select("*, package_folder_categories!inner(folder_categories!inner(categories!inner(name)))",{count:"exact",head:!0}).eq("package_folder_categories.folder_categories.categories.name",e),this}filterByFolderAndCategory(e,t){return this.query=this.query.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name), categories!inner(name)))").eq("package_folder_categories.folder_categories.folders.name",e).eq("package_folder_categories.folder_categories.categories.name",t),this.countQuery=this.countQuery.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name), categories!inner(name)))",{count:"exact",head:!0}).eq("package_folder_categories.folder_categories.folders.name",e).eq("package_folder_categories.folder_categories.categories.name",t),this}filterByTags(e,t="OR"){return e.length===0?this:(t==="OR"?(this.query=this.query.select("*, package_tags!inner(tags!inner(name))").in("package_tags.tags.name",e),this.countQuery=this.countQuery.select("*, package_tags!inner(tags!inner(name))",{count:"exact",head:!0}).in("package_tags.tags.name",e)):e.forEach(a=>{this.query=this.query.select("*, package_tags!inner(tags!inner(name))").eq("package_tags.tags.name",a),this.countQuery=this.countQuery.select("*, package_tags!inner(tags!inner(name))",{count:"exact",head:!0}).eq("package_tags.tags.name",a)}),this)}async execute(){try{const[{data:e,error:t},{count:a}]=await Promise.all([this.query,this.countQuery]);if(t)throw t;return{data:e,count:a||0,error:null}}catch(e){return console.error(`Query failed on table ${this.table}:`,e),{data:null,count:0,error:e}}}}const x=m=>new W(m);class ${static getCachedData(e){const t=this.metadataCache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_TTL?t.data:null}static setCachedData(e,t){this.metadataCache.set(e,{data:t,timestamp:Date.now()})}static clearCache(e){e?this.metadataCache.delete(e):this.metadataCache.clear()}static async fetchPackages(e){const{searchTerm:t,selectedTags:a=[],minStars:r=null,hasGithub:i,hasWebserver:s,hasPublication:n,minCitations:l=null,minRating:f=null,folder1:_=null,category1:y=null,selectedLicenses:w=[],sortBy:C="package_name",sortDirection:b="asc",page:F=1,pageSize:Q=50,includeUserRatings:T=!1,currentUserId:A=null}=e;try{let o=d.from("packages").select(`
                    *,
                    package_tags!left(
                        tag_id,
                        tags!inner(id, name)
                    ),
                    package_folder_categories!left(
                        folder_category_id,
                        folder_categories!inner(
                            id,
                            folder_id,
                            category_id,
                            folders!inner(id, name),
                            categories!inner(id, name)
                        )
                    )
                `,{count:"exact"});if(t&&(o=o.or(`package_name.ilike.%${t}%,description.ilike.%${t}%`)),a.length>0){const{data:g}=await d.from("tags").select("id, name").in("name",a);if(g&&g.length>0){const u=g.map(c=>c.id);for(const c of u){const{data:h}=await d.from("package_tags").select("package_id").eq("tag_id",c);if(h&&h.length>0){const p=h.map(k=>k.package_id);o=o.in("id",p)}else o=o.eq("id","00000000-0000-0000-0000-000000000000")}}}if(_||y){let g=d.from("folder_categories").select("id");if(_){const{data:c}=await d.from("folders").select("id").eq("name",_).single();c&&(g=g.eq("folder_id",c.id))}if(y){const{data:c}=await d.from("categories").select("id").eq("name",y).single();c&&(g=g.eq("category_id",c.id))}const{data:u}=await g;if(u&&u.length>0){const c=u.map(p=>p.id),{data:h}=await d.from("package_folder_categories").select("package_id").in("folder_category_id",c);if(h&&h.length>0){const p=h.map(k=>k.package_id);o=o.in("id",p)}else o=o.eq("id","00000000-0000-0000-0000-000000000000")}}r!==null&&(o=o.gte("github_stars",r)),i===!0&&(o=o.not("repo_link","is",null)),s===!0&&(o=o.not("webserver","is",null)),n===!0&&(o=o.not("publication","is",null)),l!==null&&(o=o.gte("citations",l)),f!==null&&(o=o.gte("average_rating",f)),w.length>0&&(o=o.in("license",w)),C&&(o=o.order(C,{ascending:b==="asc"}));const D=(F-1)*Q,P=D+Q-1;o=o.range(D,P);const{data:O,error:E,count:U}=await o;if(E)throw E;const S=(O||[]).map(g=>{var u,c,h,p,k,M,L,B,R;return{...g,tags:((u=g.package_tags)==null?void 0:u.map(j=>{var I;return(I=j.tags)==null?void 0:I.name}).filter(Boolean))||[],folder1:((k=(p=(h=(c=g.package_folder_categories)==null?void 0:c[0])==null?void 0:h.folder_categories)==null?void 0:p.folders)==null?void 0:k.name)||"",category1:((R=(B=(L=(M=g.package_folder_categories)==null?void 0:M[0])==null?void 0:L.folder_categories)==null?void 0:B.categories)==null?void 0:R.name)||""}});let v;if(T&&A){const g=S.map(c=>c.id),{data:u}=await d.from("ratings").select("package_id, rating, id").eq("user_id",A).in("package_id",g);u&&(v=new Map(u.map(c=>[c.package_id,{rating:c.rating,rating_id:c.id}])))}return{packages:S,totalCount:U||0,userRatings:v}}catch(o){throw console.error("Error fetching packages:",o),o}}static async fetchUniqueTags(){var r;const e="unique_tags",t=this.getCachedData(e);if(t)return console.log("  üìå Tags loaded from cache"),t;console.log("  üìå Fetching unique tags...");const a=performance.now();try{const i=await x("tags").select("name").orderBy("name").execute();if(i.error)throw i.error;const s=((r=i.data)==null?void 0:r.map(n=>n.name))||[];return this.setCachedData(e,s),console.log(`  üìå Tags query completed in ${((performance.now()-a)/1e3).toFixed(2)}s`),s}catch(i){throw console.error("  ‚ùå Failed to fetch tags:",i),i}}static async fetchFoldersAndCategories(){console.log("  üìÅ Fetching folders and categories...");const e=performance.now();try{const{data:t,error:a}=await d.from("folder_categories").select(`
                    folders!inner(name),
                    categories!inner(name)
                `).order("folders(name), categories(name)");if(a)throw a;const r={};t==null||t.forEach(s=>{var f,_;const n=(f=s.folders)==null?void 0:f.name,l=(_=s.categories)==null?void 0:_.name;n&&l&&(r[n]||(r[n]=[]),r[n].includes(l)||r[n].push(l))}),Object.keys(r).forEach(s=>{r[s].sort()});const i=Object.keys(r).sort();return console.log(`  üìÅ Folders/Categories fetched in ${((performance.now()-e)/1e3).toFixed(2)}s`),{folders:i,categories:r}}catch(t){throw console.error("  ‚ùå Failed to fetch folders/categories:",t),t}}static async fetchPackagesWithTag(e){try{const{data:t,error:a}=await d.from("tags").select("id").eq("name",e.trim()).single();if(a||!t)return[];const{data:r,error:i}=await d.from("packages").select(`
                    *,
                    package_tags!inner(tag_id),
                    package_tags!left(
                        tags!inner(id, name)
                    ),
                    package_folder_categories!left(
                        folder_categories!inner(
                            folders!inner(name),
                            categories!inner(name)
                        )
                    )
                `).eq("package_tags.tag_id",t.id);if(i)throw i;return(r||[]).map(s=>{var n,l,f,_,y,w,C,b,F;return{...s,tags:((n=s.package_tags)==null?void 0:n.map(Q=>{var T;return(T=Q.tags)==null?void 0:T.name}).filter(Boolean))||[],folder1:((y=(_=(f=(l=s.package_folder_categories)==null?void 0:l[0])==null?void 0:f.folder_categories)==null?void 0:_.folders)==null?void 0:y.name)||"",category1:((F=(b=(C=(w=s.package_folder_categories)==null?void 0:w[0])==null?void 0:C.folder_categories)==null?void 0:b.categories)==null?void 0:F.name)||""}})}catch(t){throw console.error("Error fetching packages with tag:",t),t}}static async fetchFilterMetadata(){console.log("üìä Fetching filter metadata...");const e=performance.now();try{console.log("üìä Starting parallel metadata queries...");const[t,a,r,i]=await Promise.all([this.fetchUniqueTags(),this.fetchUniqueLicenses(),this.fetchFoldersAndCategories(),this.fetchDatasetStats()]),s=((performance.now()-e)/1e3).toFixed(2);return console.log(`üìä Metadata fetch completed in ${s}s`),{allAvailableTags:t,allAvailableLicenses:a,allAvailableFolders:r.folders,allAvailableCategories:r.categories,datasetMaxStars:i.maxStars||0,datasetMaxCitations:i.maxCitations||0,totalPackageCount:i.totalCount}}catch(t){throw console.error("‚ùå Error fetching filter metadata:",t),t}}static async fetchUniqueLicenses(){var r,i;const e="unique_licenses",t=this.getCachedData(e);if(t)return console.log("  üìú Licenses loaded from cache"),t;console.log("  üìú Fetching unique licenses...");const a=performance.now();try{const s=await x("packages").select("license").filter("license","not","is.null").execute();if(s.error)throw console.error("  ‚ùå Licenses query error:",s.error),s.error;const n=new Set;(r=s.data)==null||r.forEach(f=>{f.license&&f.license.trim()&&n.add(f.license.trim())});const l=Array.from(n).sort();return this.setCachedData(e,l),console.log(`  üìú Licenses query completed, processed ${((i=s.data)==null?void 0:i.length)||0} rows in ${((performance.now()-a)/1e3).toFixed(2)}s`),l}catch(s){throw console.error("  ‚ùå Failed to fetch licenses:",s),s}}static async fetchDatasetStats(){var t,a,r,i;console.log("  üìä Fetching dataset statistics...");const e=performance.now();try{console.log("    ‚≠êüìöüî¢ Fetching all stats in parallel...");const[s,n,l]=await Promise.all([x("packages").select("github_stars").filter("github_stars","not","is.null").orderBy("github_stars","desc").paginate(0,1).execute(),x("packages").select("citations").filter("citations","not","is.null").orderBy("citations","desc").paginate(0,1).execute(),x("packages").select("id").execute()]);if(s.error)throw console.error("    ‚ùå Max stars query error:",s.error),s.error;if(n.error)throw console.error("    ‚ùå Max citations query error:",n.error),n.error;if(l.error)throw console.error("    ‚ùå Count query error:",l.error),l.error;return console.log(`  üìä Stats queries completed in ${((performance.now()-e)/1e3).toFixed(2)}s`),{maxStars:((a=(t=s.data)==null?void 0:t[0])==null?void 0:a.github_stars)||null,maxCitations:((i=(r=n.data)==null?void 0:r[0])==null?void 0:i.citations)||null,totalCount:l.count||0}}catch(s){throw console.error("  ‚ùå Failed to fetch dataset stats:",s),s}}static applyTagFilters(e,t,a="OR"){if(t.length===0)return e;switch(a){case"OR":return e.select("*, package_tags!inner(tags!inner(name))").in("package_tags.tags.name",t);case"AND":return t.forEach(r=>{e=e.select("*, package_tags!inner(tags!inner(name))").eq("package_tags.tags.name",r)}),e;case"SINGLE":return e.select("*, package_tags!inner(tags!inner(name))").eq("package_tags.tags.name",t[0]);default:return e}}static async refreshFilterMetadata(){console.log("üîÑ Refreshing filter metadata...");try{const e=await this.fetchFilterMetadata(),{useFilterStore:t}=await K(async()=>{const{useFilterStore:a}=await import("./index-B7UqGdPd.js").then(r=>r.aX);return{useFilterStore:a}},__vite__mapDeps([0,1]));t.setState({allAvailableTags:e.allAvailableTags,allAvailableLicenses:e.allAvailableLicenses,allAvailableFolders:e.allAvailableFolders,allAvailableCategories:e.allAvailableCategories,datasetMaxStars:e.datasetMaxStars,datasetMaxCitations:e.datasetMaxCitations}),console.log("‚úÖ Filter metadata refreshed successfully")}catch(e){throw console.error("‚ùå Error refreshing filter metadata:",e),e}}}q($,"metadataCache",new Map),q($,"CACHE_TTL",5*60*1e3);export{$ as DataService};
