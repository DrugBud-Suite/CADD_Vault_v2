var Se=t=>{throw TypeError(t)};var pe=(t,e,s)=>e.has(t)||Se("Cannot "+s);var l=(t,e,s)=>(pe(t,e,"read from private field"),s?s.call(t):e.get(t)),K=(t,e,s)=>e.has(t)?Se("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),U=(t,e,s,n)=>(pe(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s),W=(t,e,s)=>(pe(t,e,"access private method"),s);import{c as le,j as r,a as Ze,g as et,r as y,d as tt,_ as Ae,aA as Le,u as st,e as nt,aR as it,al as rt,b,s as ue,f as re,h as Ve,i as at,aS as ot,aT as lt,aU as ut,$ as ct,a2 as dt,aV as Ce,aW as gt,ab as ze,ad as me,a4 as ht,ac as pt,y as Oe,z as He,D as qe,E as De,n as ne,o as ce,ah as vt,t as Fe,ay as ft,I as mt,v as je,T as ie,aN as yt,V as bt,A as xt,H as Rt}from"./index-C2YGcSFf.js";import{D as _t}from"./Delete-BIY9NIn1.js";import{u as St,q as f,c as oe}from"./queryKeys-Brr6lFbz.js";const Ct=le(r.jsx("path",{d:"M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"}),"Star"),Ft=le(r.jsx("path",{d:"M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"}),"StarBorder");function jt(t){return et("MuiRating",t)}const G=Ze("MuiRating",["root","sizeSmall","sizeMedium","sizeLarge","readOnly","disabled","focusVisible","visuallyHidden","pristine","label","labelEmptyValueActive","icon","iconEmpty","iconFilled","iconHover","iconFocus","iconActive","decimal"]),Mt=["value"],wt=["className","defaultValue","disabled","emptyIcon","emptyLabelText","getLabelText","highlightSelectedOnly","icon","IconContainerComponent","max","name","onChange","onChangeActive","onMouseLeave","onMouseMove","precision","readOnly","size","value"];function Et(t){const e=t.toString().split(".")[1];return e?e.length:0}function ve(t,e){if(t==null)return t;const s=Math.round(t/e)*e;return Number(s.toFixed(Et(e)))}const Pt=t=>{const{classes:e,size:s,readOnly:n,disabled:i,emptyValueFocused:a,focusVisible:o}=t,d={root:["root",`size${Ve(s)}`,i&&"disabled",o&&"focusVisible",n&&"readOnly"],label:["label","pristine"],labelEmptyValue:[a&&"labelEmptyValueActive"],icon:["icon"],iconEmpty:["iconEmpty"],iconFilled:["iconFilled"],iconHover:["iconHover"],iconFocus:["iconFocus"],iconActive:["iconActive"],decimal:["decimal"],visuallyHidden:["visuallyHidden"]};return at(d,jt,e)},At=ue("span",{name:"MuiRating",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:s}=t;return[{[`& .${G.visuallyHidden}`]:e.visuallyHidden},e.root,e[`size${Ve(s.size)}`],s.readOnly&&e.readOnly]}})(({theme:t,ownerState:e})=>b({display:"inline-flex",position:"relative",fontSize:t.typography.pxToRem(24),color:"#faaf00",cursor:"pointer",textAlign:"left",width:"min-content",WebkitTapHighlightColor:"transparent",[`&.${G.disabled}`]:{opacity:(t.vars||t).palette.action.disabledOpacity,pointerEvents:"none"},[`&.${G.focusVisible} .${G.iconActive}`]:{outline:"1px solid #999"},[`& .${G.visuallyHidden}`]:ot},e.size==="small"&&{fontSize:t.typography.pxToRem(18)},e.size==="large"&&{fontSize:t.typography.pxToRem(30)},e.readOnly&&{pointerEvents:"none"})),Ie=ue("label",{name:"MuiRating",slot:"Label",overridesResolver:({ownerState:t},e)=>[e.label,t.emptyValueFocused&&e.labelEmptyValueActive]})(({ownerState:t})=>b({cursor:"inherit"},t.emptyValueFocused&&{top:0,bottom:0,position:"absolute",outline:"1px solid #999",width:"100%"})),Lt=ue("span",{name:"MuiRating",slot:"Icon",overridesResolver:(t,e)=>{const{ownerState:s}=t;return[e.icon,s.iconEmpty&&e.iconEmpty,s.iconFilled&&e.iconFilled,s.iconHover&&e.iconHover,s.iconFocus&&e.iconFocus,s.iconActive&&e.iconActive]}})(({theme:t,ownerState:e})=>b({display:"flex",transition:t.transitions.create("transform",{duration:t.transitions.duration.shortest}),pointerEvents:"none"},e.iconActive&&{transform:"scale(1.2)"},e.iconEmpty&&{color:(t.vars||t).palette.action.disabled})),Vt=ue("span",{name:"MuiRating",slot:"Decimal",shouldForwardProp:t=>lt(t)&&t!=="iconActive",overridesResolver:(t,e)=>{const{iconActive:s}=t;return[e.decimal,s&&e.iconActive]}})(({iconActive:t})=>b({position:"relative"},t&&{transform:"scale(1.2)"}));function zt(t){const e=Ae(t,Mt);return r.jsx("span",b({},e))}function Me(t){const{classes:e,disabled:s,emptyIcon:n,focus:i,getLabelText:a,highlightSelectedOnly:o,hover:d,icon:c,IconContainerComponent:_,isActive:h,itemValue:g,labelProps:A,name:j,onBlur:S,onChange:L,onClick:C,onFocus:I,readOnly:T,ownerState:p,ratingValue:x,ratingValueRounded:V}=t,F=o?g===x:g<=x,B=g<=d,$=g<=i,de=g===V,X=Le(),q=r.jsx(Lt,{as:_,value:g,className:re(e.icon,F?e.iconFilled:e.iconEmpty,B&&e.iconHover,$&&e.iconFocus,h&&e.iconActive),ownerState:b({},p,{iconEmpty:!F,iconFilled:F,iconHover:B,iconFocus:$,iconActive:h}),children:n&&!F?n:c});return T?r.jsx("span",b({},A,{children:q})):r.jsxs(y.Fragment,{children:[r.jsxs(Ie,b({ownerState:b({},p,{emptyValueFocused:void 0}),htmlFor:X},A,{children:[q,r.jsx("span",{className:e.visuallyHidden,children:a(g)})]})),r.jsx("input",{className:e.visuallyHidden,onFocus:I,onBlur:S,onChange:L,onClick:C,disabled:s,value:g,id:X,type:"radio",name:j,checked:de})]})}const Ot=r.jsx(Ct,{fontSize:"inherit"}),Ht=r.jsx(Ft,{fontSize:"inherit"});function qt(t){return`${t} Star${t!==1?"s":""}`}const Dt=y.forwardRef(function(e,s){const n=tt({name:"MuiRating",props:e}),{className:i,defaultValue:a=null,disabled:o=!1,emptyIcon:d=Ht,emptyLabelText:c="Empty",getLabelText:_=qt,highlightSelectedOnly:h=!1,icon:g=Ot,IconContainerComponent:A=zt,max:j=5,name:S,onChange:L,onChangeActive:C,onMouseLeave:I,onMouseMove:T,precision:p=1,readOnly:x=!1,size:V="medium",value:F}=n,B=Ae(n,wt),$=Le(S),[de,X]=st({controlled:F,default:a,name:"Rating"}),q=ve(de,p),Be=nt(),[{hover:M,focus:te},Y]=y.useState({hover:-1,focus:-1});let Q=q;M!==-1&&(Q=M),te!==-1&&(Q=te);const{isFocusVisibleRef:be,onBlur:$e,onFocus:Qe,ref:ke}=it(),[Ne,ge]=y.useState(!1),xe=y.useRef(),Ke=rt(ke,xe,s),Ue=u=>{T&&T(u);const v=xe.current,{right:R,left:se,width:k}=v.getBoundingClientRect();let N;Be?N=(R-u.clientX)/k:N=(u.clientX-se)/k;let w=ve(j*N+p/2,p);w=ut(w,p,j),Y(D=>D.hover===w&&D.focus===w?D:{hover:w,focus:w}),ge(!1),C&&M!==w&&C(u,w)},We=u=>{I&&I(u);const v=-1;Y({hover:v,focus:v}),C&&M!==v&&C(u,v)},Re=u=>{let v=u.target.value===""?null:parseFloat(u.target.value);M!==-1&&(v=M),X(v),L&&L(u,v)},Xe=u=>{u.clientX===0&&u.clientY===0||(Y({hover:-1,focus:-1}),X(null),L&&parseFloat(u.target.value)===q&&L(u,null))},Ye=u=>{Qe(u),be.current===!0&&ge(!0);const v=parseFloat(u.target.value);Y(R=>({hover:R.hover,focus:v}))},Je=u=>{if(M!==-1)return;$e(u),be.current===!1&&ge(!1);const v=-1;Y(R=>({hover:R.hover,focus:v}))},[Ge,_e]=y.useState(!1),J=b({},n,{defaultValue:a,disabled:o,emptyIcon:d,emptyLabelText:c,emptyValueFocused:Ge,focusVisible:Ne,getLabelText:_,icon:g,IconContainerComponent:A,max:j,precision:p,readOnly:x,size:V}),z=Pt(J);return r.jsxs(At,b({ref:Ke,onMouseMove:Ue,onMouseLeave:We,className:re(z.root,i,x&&"MuiRating-readOnly"),ownerState:J,role:x?"img":null,"aria-label":x?_(Q):null},B,{children:[Array.from(new Array(j)).map((u,v)=>{const R=v+1,se={classes:z,disabled:o,emptyIcon:d,focus:te,getLabelText:_,highlightSelectedOnly:h,hover:M,icon:g,IconContainerComponent:A,name:$,onBlur:Je,onChange:Re,onClick:Xe,onFocus:Ye,ratingValue:Q,ratingValueRounded:q,readOnly:x,ownerState:J},k=R===Math.ceil(Q)&&(M!==-1||te!==-1);if(p<1){const N=Array.from(new Array(1/p));return r.jsx(Vt,{className:re(z.decimal,k&&z.iconActive),ownerState:J,iconActive:k,children:N.map((w,D)=>{const he=ve(R-1+(D+1)*p,p);return r.jsx(Me,b({},se,{isActive:!1,itemValue:he,labelProps:{style:N.length-1===D?{}:{width:he===Q?`${(D+1)*p*100}%`:"0%",overflow:"hidden",position:"absolute"}}}),he)})},R)}return r.jsx(Me,b({},se,{isActive:k,itemValue:R}),R)}),!x&&!o&&r.jsxs(Ie,{className:re(z.label,z.labelEmptyValue),ownerState:J,children:[r.jsx("input",{className:z.visuallyHidden,value:"",id:`${$}-empty`,type:"radio",name:$,checked:q==null,onFocus:()=>_e(!0),onBlur:()=>_e(!1),onChange:Re}),r.jsx("span",{className:z.visuallyHidden,children:c})]})]}))});var O,H,m,E,P,ae,fe,Pe,It=(Pe=class extends ct{constructor(e,s){super();K(this,P);K(this,O);K(this,H);K(this,m);K(this,E);U(this,O,e),this.setOptions(s),this.bindMethods(),W(this,P,ae).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var n;const s=this.options;this.options=l(this,O).defaultMutationOptions(e),dt(this.options,s)||l(this,O).getMutationCache().notify({type:"observerOptionsUpdated",mutation:l(this,m),observer:this}),s!=null&&s.mutationKey&&this.options.mutationKey&&Ce(s.mutationKey)!==Ce(this.options.mutationKey)?this.reset():((n=l(this,m))==null?void 0:n.state.status)==="pending"&&l(this,m).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=l(this,m))==null||e.removeObserver(this)}onMutationUpdate(e){W(this,P,ae).call(this),W(this,P,fe).call(this,e)}getCurrentResult(){return l(this,H)}reset(){var e;(e=l(this,m))==null||e.removeObserver(this),U(this,m,void 0),W(this,P,ae).call(this),W(this,P,fe).call(this)}mutate(e,s){var n;return U(this,E,s),(n=l(this,m))==null||n.removeObserver(this),U(this,m,l(this,O).getMutationCache().build(l(this,O),this.options)),l(this,m).addObserver(this),l(this,m).execute(e)}},O=new WeakMap,H=new WeakMap,m=new WeakMap,E=new WeakMap,P=new WeakSet,ae=function(){var s;const e=((s=l(this,m))==null?void 0:s.state)??gt();U(this,H,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},fe=function(e){ze.batch(()=>{var s,n,i,a,o,d,c,_;if(l(this,E)&&this.hasListeners()){const h=l(this,H).variables,g=l(this,H).context;(e==null?void 0:e.type)==="success"?((n=(s=l(this,E)).onSuccess)==null||n.call(s,e.data,h,g),(a=(i=l(this,E)).onSettled)==null||a.call(i,e.data,null,h,g)):(e==null?void 0:e.type)==="error"&&((d=(o=l(this,E)).onError)==null||d.call(o,e.error,h,g),(_=(c=l(this,E)).onSettled)==null||_.call(c,void 0,e.error,h,g))}this.listeners.forEach(h=>{h(l(this,H))})})},Pe);function Te(t,e){const s=me(),[n]=y.useState(()=>new It(s,t));y.useEffect(()=>{n.setOptions(t)},[n,t]);const i=y.useSyncExternalStore(y.useCallback(o=>n.subscribe(ze.batchCalls(o)),[n]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),a=y.useCallback((o,d)=>{n.mutate(o,d).catch(ht)},[n]);if(i.error&&pt(n.options.throwOnError,[i.error]))throw i.error;return{...i,mutate:a,mutateAsync:i.mutate}}const Zt=le(r.jsx("path",{d:"M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6z"}),"Code"),es=le(r.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"}),"Link");var Z={},we;function Tt(){if(we)return Z;we=1;var t=Oe();Object.defineProperty(Z,"__esModule",{value:!0}),Z.default=void 0;var e=t(He()),s=qe();return Z.default=(0,e.default)((0,s.jsx)("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"}),"Star"),Z}var Bt=Tt();const $t=De(Bt);var ee={},Ee;function Qt(){if(Ee)return ee;Ee=1;var t=Oe();Object.defineProperty(ee,"__esModule",{value:!0}),ee.default=void 0;var e=t(He()),s=qe();return ee.default=(0,e.default)((0,s.jsx)("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorder"),ee}var kt=Qt();const Nt=De(kt),ye={async getPackageRating(t,e){const{data:s,error:n}=await ne.rpc("get_package_rating_stats",{package_uuid:t});if(n)throw n;let i=null;if(e){const{data:o,error:d}=await ne.rpc("get_user_rating",{package_uuid:t});if(d)throw d;i=o==null?void 0:o[0]}const a=(s==null?void 0:s[0])||{average_rating:0,ratings_count:0};return{average_rating:a.average_rating||0,ratings_count:a.ratings_count||0,user_rating:i==null?void 0:i.rating,rating_id:i==null?void 0:i.rating_id}},async upsertRating(t,e){const{data:s,error:n}=await ne.rpc("upsert_rating",{package_uuid:t,new_rating:e});if(n)throw n;const i=s==null?void 0:s[0];if(!i)throw new Error("Failed to upsert rating");return{average_rating:i.average_rating,ratings_count:i.ratings_count,user_rating:i.user_rating,rating_id:i.rating_id}},async deleteRating(t){const{data:e,error:s}=await ne.rpc("delete_user_rating",{package_uuid:t});if(s)throw s;const n=e==null?void 0:e[0];if(!n)throw new Error("Failed to delete rating");return{average_rating:n.average_rating,ratings_count:n.ratings_count,user_rating:void 0,rating_id:void 0}}};function Kt(t){const{currentUser:e}=ce();return St({queryKey:f.ratings.user(t,(e==null?void 0:e.id)||"anonymous"),queryFn:()=>ye.getPackageRating(t,e==null?void 0:e.id),enabled:!!t,staleTime:1e3*60*2})}function Ut(){const t=me(),{currentUser:e}=ce();return Te({mutationFn:({packageId:s,rating:n})=>ye.upsertRating(s,n),onMutate:async({packageId:s,rating:n})=>{if(!e)return;await t.cancelQueries({queryKey:f.ratings.user(s,e.id)});const i=t.getQueryData(f.ratings.user(s,e.id));if(i){const a=!i.user_rating,o=i.user_rating||0,d=a?i.ratings_count+1:i.ratings_count;let c;a?c=(i.average_rating*i.ratings_count+n)/d:c=(i.average_rating*i.ratings_count-o+n)/d,t.setQueryData(f.ratings.user(s,e.id),{...i,average_rating:Math.round(c*10)/10,ratings_count:d,user_rating:n})}return{previousData:i}},onError:(s,{packageId:n},i)=>{e&&(i!=null&&i.previousData&&t.setQueryData(f.ratings.user(n,e.id),i.previousData),oe.error("Failed to update rating"))},onSuccess:(s,{packageId:n})=>{e&&(t.setQueryData(f.ratings.user(n,e.id),s),t.invalidateQueries({queryKey:f.packages.detail(n)}),t.invalidateQueries({queryKey:f.packages.lists()}),oe.success("Rating updated successfully"))}})}function Wt(){const t=me(),{currentUser:e}=ce();return Te({mutationFn:s=>ye.deleteRating(s),onMutate:async s=>{if(!e)return;await t.cancelQueries({queryKey:f.ratings.user(s,e.id)});const n=t.getQueryData(f.ratings.user(s,e.id));if(n&&n.user_rating){const i=Math.max(0,n.ratings_count-1),a=i>0?(n.average_rating*n.ratings_count-n.user_rating)/i:0;t.setQueryData(f.ratings.user(s,e.id),{...n,average_rating:Math.round(a*10)/10,ratings_count:i,user_rating:void 0,rating_id:void 0})}return{previousData:n}},onError:(s,n,i)=>{e&&(i!=null&&i.previousData&&t.setQueryData(f.ratings.user(n,e.id),i.previousData),oe.error("Failed to remove rating"))},onSuccess:(s,n)=>{e&&(t.setQueryData(f.ratings.user(n,e.id),s),t.invalidateQueries({queryKey:f.packages.detail(n)}),t.invalidateQueries({queryKey:f.packages.lists()}),oe.success("Rating removed successfully"))}})}const ts=({packageId:t})=>{const{currentUser:e}=ce(),{data:s,isLoading:n}=Kt(t),i=Ut(),a=Wt(),o=(s==null?void 0:s.average_rating)||0,d=(s==null?void 0:s.ratings_count)||0,c=(s==null?void 0:s.user_rating)||null,[_,h]=y.useState(c),[g,A]=y.useState(null),[j,S]=y.useState(null);vt.useEffect(()=>{h(c)},[c]);const L=V=>{e&&(A(V.currentTarget),S(null))},C=()=>{A(null),h(c),S(null)},I=async(V,F)=>{if(!(!e||F===null||i.isPending)){S(null),h(F);try{await i.mutateAsync({packageId:t,rating:F}),setTimeout(()=>{C()},500)}catch(B){console.error("Error submitting rating:",B),S("Failed to submit rating. Please try again."),h(c)}}},T=async()=>{if(!(!e||!c||a.isPending)){S(null);try{await a.mutateAsync(t),C()}catch(V){console.error("Error deleting rating:",V),S("Failed to delete rating. Please try again.")}}},p=!!g,x=p?`rating-popover-${t}`:void 0;return r.jsxs(Fe,{sx:{display:"flex",alignItems:"center",gap:.5},children:[r.jsx(ft,{title:e?"Rate this package":"Login to rate",children:r.jsx("span",{children:r.jsx(mt,{size:"small",onClick:L,"aria-describedby":x,disabled:n||i.isPending||a.isPending||!e,sx:{p:.5},children:n||i.isPending||a.isPending?r.jsx(je,{size:20}):r.jsx($t,{fontSize:"inherit",sx:{color:o>0?"warning.main":"action.disabled"}})})})}),r.jsx(ie,{variant:"body2",sx:{fontWeight:"medium",minWidth:"2ch"},children:o.toFixed(1)}),r.jsxs(ie,{variant:"body2",color:"text.secondary",sx:{minWidth:"3ch"},children:["(",d,")"]}),r.jsx(yt,{id:x,open:p,anchorEl:g,onClose:C,anchorOrigin:{vertical:"bottom",horizontal:"center"},transformOrigin:{vertical:"top",horizontal:"center"},PaperProps:{sx:{p:2,minWidth:200}},children:r.jsxs(bt,{spacing:2,alignItems:"center",children:[r.jsx(ie,{variant:"subtitle2",color:"text.primary",children:c?"Update Your Rating":"Rate This Package"}),j&&r.jsx(xt,{severity:"error",sx:{width:"100%",py:.5},children:j}),r.jsx(Dt,{name:`rating-${t}`,value:_,onChange:I,precision:1,emptyIcon:r.jsx(Nt,{fontSize:"inherit"}),disabled:i.isPending||a.isPending,sx:{fontSize:"1.5rem"}}),c&&r.jsx(Rt,{variant:"outlined",color:"error",size:"small",startIcon:r.jsx(_t,{}),onClick:T,disabled:i.isPending||a.isPending,sx:{mt:1},children:"Remove Rating"}),(i.isPending||a.isPending)&&r.jsxs(Fe,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(je,{size:16}),r.jsx(ie,{variant:"caption",color:"text.secondary",children:a.isPending?"Removing...":c?"Updating...":"Submitting..."})]})]})})]})};export{Zt as C,es as L,ts as R};
