import{V as K,W as Z,v as ee,r as s,n as m,j as e,t as ae,y as E,T as k,X as re,ah as u,F as q,ai as B,S as G,M as C,aj as te,R as ne,Q as oe,L as N}from"./index-QxSUAMeM.js";import{G as i}from"./Grid-D4ArmYgK.js";const ie=()=>{const{packageId:I}=K(),c=I?decodeURIComponent(I):void 0,b=Z(),{isAdmin:l,loading:w}=ee(),[r,p]=s.useState({}),[f,$]=s.useState(!1),[h,y]=s.useState(!1),[x,v]=s.useState(null),[z,H]=s.useState([]),[S,L]=s.useState(!1),[M,O]=s.useState([]),[Q,P]=s.useState([]),A=s.useCallback(async()=>{var t,a,o,n,j,_,T,W,R;if(!(!c||!l)){y(!0),v(null);try{const{data:d,error:D}=await m.from("packages").select(`
                *,
                package_tags!left(
                    tags!inner(name)
                ),
                package_folder_categories!left(
                    folder_categories!inner(
                        folders!inner(name),
                        categories!inner(name)
                    )
                )
            `).eq("id",c).single();if(D)throw D;if(d){const Y={...d,tags:((t=d.package_tags)==null?void 0:t.map(J=>{var U;return(U=J.tags)==null?void 0:U.name}).filter(Boolean))||[],folder:((j=(n=(o=(a=d.package_folder_categories)==null?void 0:a[0])==null?void 0:o.folder_categories)==null?void 0:n.folders)==null?void 0:j.name)||"",category:((R=(W=(T=(_=d.package_folder_categories)==null?void 0:_[0])==null?void 0:T.folder_categories)==null?void 0:W.categories)==null?void 0:R.name)||""};p(Y),$(!0)}}catch(d){console.error("Error fetching package:",d),v(`Failed to load package data: ${d.message}`)}finally{y(!1)}}},[c,l]);s.useEffect(()=>{if(!w&&!l){console.warn("Access denied: User is not an admin."),b("/");return}l&&c&&!f&&A()},[l,w,b,c,f,A]),s.useEffect(()=>{l&&(async()=>{if(l){L(!0);try{const{data:a,error:o}=await m.from("tags").select("name").order("name");if(o)throw o;H((a==null?void 0:a.map(n=>n.name))||[])}catch(a){console.error("Error fetching tags:",a)}finally{L(!1)}}})()},[l]),s.useEffect(()=>{l&&(async()=>{if(l)try{const{data:a,error:o}=await m.from("folders").select("name").order("name");if(o)throw o;if(O((a==null?void 0:a.map(n=>n.name))||[]),r.folder){const{data:n,error:j}=await m.from("folder_categories").select(`
							categories!inner(name),
							folders!inner(name)
						`).eq("folders.name",r.folder);if(j)throw j;P((n==null?void 0:n.map(_=>_.categories.name))||[])}}catch(a){console.error("Error fetching folders/categories:",a)}})()},[l,r.folder]);const g=t=>{const{name:a,value:o}=t.target;p(n=>({...n,[a]:o}))},V=(t,a)=>{p(o=>({...o,tags:a}))},F=t=>{const{name:a,value:o}=t.target;p(n=>({...n,[a]:o})),a==="folder"&&(p(n=>({...n,category:""})),P([]))},X=async t=>{if(t.preventDefault(),v(null),!c||!r.package_name){v("Package ID and name are required.");return}y(!0);try{const{error:a}=await m.from("packages").update({package_name:r.package_name,description:r.description||null,publication:r.publication||null,webserver:r.webserver||null,repo_link:r.repo_link||null,link:r.link||null,license:r.license||null,last_updated:new Date().toISOString()}).eq("id",c);if(a)throw a;const{error:o}=await m.rpc("update_package_tags",{package_uuid:c,new_tags:r.tags||[]});o&&console.error("Error updating tags:",o);const{error:n}=await m.rpc("update_package_folder_category",{package_uuid:c,folder_name:r.folder||"",category_name:r.category||""});n&&console.error("Error updating folder/category:",n),b(`/package/${encodeURIComponent(c)}`)}catch(a){console.error("Error updating package:",a),v(`Failed to update package: ${a.message}`)}finally{y(!1)}};return w||l&&!f&&!x?e.jsx(ae,{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",children:e.jsx(E,{})}):l?x&&!f?e.jsx(k,{color:"error",align:"center",children:x}):l&&!f?e.jsx(k,{color:"error",align:"center",children:"Could not load package data."}):e.jsxs(re,{elevation:3,sx:{p:3,m:2},children:[e.jsxs(k,{variant:"h4",gutterBottom:!0,component:"div",children:["Edit Package: ",r.package_name||"..."]}),e.jsx("form",{onSubmit:X,children:e.jsxs(i,{container:!0,spacing:3,children:[e.jsx(i,{item:!0,xs:12,children:e.jsx(u,{id:"package_name",label:"Package Name (package_name)",name:"package_name",value:r.package_name||"",onChange:g,required:!0,fullWidth:!0,variant:"outlined"})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(u,{id:"description",label:"Description",name:"description",value:r.description||"",onChange:g,multiline:!0,rows:4,fullWidth:!0,variant:"outlined"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"publication",label:"Publication URL",name:"publication",value:r.publication||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"webserver",label:"Webserver/Homepage URL",name:"webserver",value:r.webserver||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"repo_link",label:"Code Repository Link (GitHub or other)",name:"repo_link",value:r.repo_link||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url",helperText:"Enter the URL for the code repository"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"link",label:"General Link",name:"link",value:r.link||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url",helperText:"Any other relevant link (not publication or webserver)"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"license",label:"License",name:"license",value:r.license||"",onChange:g,fullWidth:!0,variant:"outlined"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(q,{fullWidth:!0,variant:"outlined",children:[e.jsx(B,{id:"folder-label",children:"Folder"}),e.jsxs(G,{labelId:"folder-label",id:"folder",name:"folder",value:r.folder||"",onChange:F,label:"Folder",children:[e.jsx(C,{value:"",children:e.jsx("em",{children:"None"})}),M.map(t=>e.jsx(C,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(q,{fullWidth:!0,variant:"outlined",children:[e.jsx(B,{id:"category-label",children:"Category"}),e.jsxs(G,{labelId:"category-label",id:"category",name:"category",value:r.category||"",onChange:F,label:"Category",disabled:!r.folder,children:[e.jsx(C,{value:"",children:e.jsx("em",{children:"None"})}),Q.map(t=>e.jsx(C,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(te,{multiple:!0,id:"tags-filled",options:z,loading:S,value:r.tags||[],onChange:V,freeSolo:!0,renderTags:(t,a)=>t.map((o,n)=>e.jsx(oe,{variant:"outlined",label:o,...a({index:n})})),renderInput:t=>e.jsx(u,{...t,id:"tags-input",name:"tags",variant:"outlined",label:"Tags",placeholder:"Add or select tags",InputProps:{...t.InputProps,endAdornment:e.jsxs(ne.Fragment,{children:[S?e.jsx(E,{color:"inherit",size:20}):null,t.InputProps.endAdornment]})}})})}),e.jsxs(i,{item:!0,xs:12,children:[x&&!h&&e.jsx(k,{color:"error",sx:{mb:2},children:x}),e.jsx(N,{type:"submit",variant:"contained",color:"primary",disabled:h,startIcon:h?e.jsx(E,{size:20}):null,children:h?"Saving...":"Save Changes"}),e.jsx(N,{variant:"outlined",color:"secondary",onClick:()=>b(`/package/${encodeURIComponent(c||"")}`),sx:{ml:2},disabled:h,children:"Cancel"})]})]})})]}):e.jsx(k,{color:"error",align:"center",children:"Access Denied. You must be an admin to edit packages."})};export{ie as default};
