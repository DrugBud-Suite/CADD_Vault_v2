const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CwGLBZlN.js","assets/index-B7rZpWz0.css"])))=>i.map(i=>d[i]);
var J=Object.defineProperty;var X=(h,e,t)=>e in h?J(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var y=(h,e,t)=>X(h,typeof e!="symbol"?e+"":e,t);import{n as d,z as Y}from"./index-CwGLBZlN.js";class Z{constructor(e){y(this,"query");y(this,"countQuery");y(this,"table");this.table=e,this.query=d.from(e).select("*"),this.countQuery=d.from(e).select("*",{count:"exact",head:!0})}select(e){return this.query=d.from(this.table).select(e),this.countQuery=d.from(this.table).select("*",{count:"exact",head:!0}),this}filter(e,t,r){return this.query=this.query[t](e,r),this.countQuery=this.countQuery[t](e,r),this}filters(e){return e.forEach(({field:t,operator:r,value:s})=>{this.filter(t,r,s)}),this}search(e,t){return t&&(this.query=this.query.ilike(e,`%${t}%`),this.countQuery=this.countQuery.ilike(e,`%${t}%`)),this}paginate(e,t){const r=e*t,s=r+t-1;return this.query=this.query.range(r,s),this}orderBy(e,t="asc"){return this.query=this.query.order(e,{ascending:t==="asc"}),this}filterByFolder(e){return this.query=this.query.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name)))").eq("package_folder_categories.folder_categories.folders.name",e),this.countQuery=this.countQuery.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name)))",{count:"exact",head:!0}).eq("package_folder_categories.folder_categories.folders.name",e),this}filterByCategory(e){return this.query=this.query.select("*, package_folder_categories!inner(folder_categories!inner(categories!inner(name)))").eq("package_folder_categories.folder_categories.categories.name",e),this.countQuery=this.countQuery.select("*, package_folder_categories!inner(folder_categories!inner(categories!inner(name)))",{count:"exact",head:!0}).eq("package_folder_categories.folder_categories.categories.name",e),this}filterByFolderAndCategory(e,t){return this.query=this.query.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name), categories!inner(name)))").eq("package_folder_categories.folder_categories.folders.name",e).eq("package_folder_categories.folder_categories.categories.name",t),this.countQuery=this.countQuery.select("*, package_folder_categories!inner(folder_categories!inner(folders!inner(name), categories!inner(name)))",{count:"exact",head:!0}).eq("package_folder_categories.folder_categories.folders.name",e).eq("package_folder_categories.folder_categories.categories.name",t),this}filterByTags(e,t="OR"){return e.length===0?this:(t==="OR"?(this.query=this.query.select("*, package_tags!inner(tags!inner(name))").in("package_tags.tags.name",e),this.countQuery=this.countQuery.select("*, package_tags!inner(tags!inner(name))",{count:"exact",head:!0}).in("package_tags.tags.name",e)):e.forEach(r=>{this.query=this.query.select("*, package_tags!inner(tags!inner(name))").eq("package_tags.tags.name",r),this.countQuery=this.countQuery.select("*, package_tags!inner(tags!inner(name))",{count:"exact",head:!0}).eq("package_tags.tags.name",r)}),this)}async execute(){try{const[{data:e,error:t},{count:r}]=await Promise.all([this.query,this.countQuery]);if(t)throw t;return{data:e,count:r||0,error:null}}catch(e){return console.error(`Query failed on table ${this.table}:`,e),{data:null,count:0,error:e}}}}const b=h=>new Z(h);class K{static getCachedData(e){const t=this.metadataCache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_TTL?t.data:null}static setCachedData(e,t){this.metadataCache.set(e,{data:t,timestamp:Date.now()})}static clearCache(e){e?this.metadataCache.delete(e):this.metadataCache.clear()}static async fetchPackages(e){const{searchTerm:t,selectedTags:r=[],minStars:s=null,hasGithub:i,hasWebserver:o,hasPublication:c,minCitations:l=null,minRating:f=null,folder:_=null,category:F=null,selectedLicenses:Q=[],sortBy:k="package_name",sortDirection:T="asc",page:A=1,pageSize:q=50,includeUserRatings:D=!1,currentUserId:w=null}=e;try{let a=d.from("packages").select(`
                    *,
                    package_tags!left(
                        tag_id,
                        tags!inner(id, name)
                    ),
                    package_folder_categories!left(
                        folder_category_id,
                        folder_categories!inner(
                            id,
                            folder_id,
                            category_id,
                            folders!inner(id, name),
                            categories!inner(id, name)
                        )
                    )
                `,{count:"exact"});if(t&&(a=a.or(`package_name.ilike.%${t}%,description.ilike.%${t}%`)),r.length>0){const{data:g}=await d.from("tags").select("id, name").in("name",r);if(g&&g.length>0){const u=g.map(n=>n.id);for(const n of u){const{data:m}=await d.from("package_tags").select("package_id").eq("tag_id",n);if(m&&m.length>0){const p=m.map(S=>S.package_id);a=a.in("id",p)}else a=a.eq("id","00000000-0000-0000-0000-000000000000")}}}if(_||F){let g=d.from("folder_categories").select("id");if(_){const{data:n}=await d.from("folders").select("id").eq("name",_).single();n&&(g=g.eq("folder_id",n.id))}if(F){const{data:n}=await d.from("categories").select("id").eq("name",F).single();n&&(g=g.eq("category_id",n.id))}const{data:u}=await g;if(u&&u.length>0){const n=u.map(p=>p.id),{data:m}=await d.from("package_folder_categories").select("package_id").in("folder_category_id",n);if(m&&m.length>0){const p=m.map(S=>S.package_id);a=a.in("id",p)}else a=a.eq("id","00000000-0000-0000-0000-000000000000")}}s!==null&&(a=a.gte("github_stars",s)),i===!0&&(a=a.not("repo_link","is",null)),o===!0&&(a=a.not("webserver","is",null)),c===!0&&(a=a.not("publication","is",null)),l!==null&&(a=a.gte("citations",l)),f!==null&&(a=a.gte("average_rating",f)),Q.length>0&&(a=a.in("license",Q)),k&&(a=a.order(k,{ascending:T==="asc"}));const C=(A-1)*q,E=C+q-1;a=a.range(C,E);const{data:v,error:x,count:W}=await a;if(x)throw x;const M=(v||[]).map(g=>{var B,R,$,I,P,O,U,j,G;const u=((B=g.package_tags)==null?void 0:B.map(V=>{var H;return(H=V.tags)==null?void 0:H.name}).filter(Boolean))||[],n=((P=(I=($=(R=g.package_folder_categories)==null?void 0:R[0])==null?void 0:$.folder_categories)==null?void 0:I.folders)==null?void 0:P.name)||"",m=((G=(j=(U=(O=g.package_folder_categories)==null?void 0:O[0])==null?void 0:U.folder_categories)==null?void 0:j.categories)==null?void 0:G.name)||"",{package_tags:p,package_folder_categories:S,...z}=g;return{...z,tags:u,folder:n,category:m}});let L;if(D&&w){const g=M.map(n=>n.id),{data:u}=await d.from("ratings").select("package_id, rating, id").eq("user_id",w).in("package_id",g);u&&(L=new Map(u.map(n=>[n.package_id,{rating:n.rating,rating_id:n.id}])))}return{packages:M,totalCount:W||0,userRatings:L}}catch(a){throw console.error("Error fetching packages:",a),a}}static async fetchUniqueTags(){var s;const e="unique_tags",t=this.getCachedData(e);if(t)return console.log("  📌 Tags loaded from cache"),t;console.log("  📌 Fetching unique tags...");const r=performance.now();try{const i=await b("tags").select("name").orderBy("name").execute();if(i.error)throw i.error;const o=((s=i.data)==null?void 0:s.map(c=>c.name))||[];return this.setCachedData(e,o),console.log(`  📌 Tags query completed in ${((performance.now()-r)/1e3).toFixed(2)}s`),o}catch(i){throw console.error("  ❌ Failed to fetch tags:",i),i}}static async fetchFoldersAndCategories(){console.log("  📁 Fetching folders and categories...");const e=performance.now();try{const{data:t,error:r}=await d.from("folder_categories").select(`
                    folders!inner(name),
                    categories!inner(name)
                `).order("folders(name), categories(name)");if(r)throw r;const s={};t==null||t.forEach(o=>{var f,_;const c=(f=o.folders)==null?void 0:f.name,l=(_=o.categories)==null?void 0:_.name;c&&l&&(s[c]||(s[c]=[]),s[c].includes(l)||s[c].push(l))}),Object.keys(s).forEach(o=>{s[o].sort()});const i=Object.keys(s).sort();return console.log(`  📁 Folders/Categories fetched in ${((performance.now()-e)/1e3).toFixed(2)}s`),{folders:i,categories:s}}catch(t){throw console.error("  ❌ Failed to fetch folders/categories:",t),t}}static async fetchPackagesWithTag(e){try{const{data:t,error:r}=await d.from("tags").select("id").eq("name",e.trim()).single();if(r||!t)return[];const{data:s,error:i}=await d.from("packages").select(`
                    *,
                    package_tags!inner(tag_id),
                    package_tags!left(
                        tags!inner(id, name)
                    ),
                    package_folder_categories!left(
                        folder_categories!inner(
                            folders!inner(name),
                            categories!inner(name)
                        )
                    )
                `).eq("package_tags.tag_id",t.id);if(i)throw i;return(s||[]).map(o=>{var k,T,A,q,D,w,a,C,E;const c=((k=o.package_tags)==null?void 0:k.map(v=>{var x;return(x=v.tags)==null?void 0:x.name}).filter(Boolean))||[],l=((D=(q=(A=(T=o.package_folder_categories)==null?void 0:T[0])==null?void 0:A.folder_categories)==null?void 0:q.folders)==null?void 0:D.name)||"",f=((E=(C=(a=(w=o.package_folder_categories)==null?void 0:w[0])==null?void 0:a.folder_categories)==null?void 0:C.categories)==null?void 0:E.name)||"",{package_tags:_,package_folder_categories:F,...Q}=o;return{...Q,tags:c,folder:l,category:f}})}catch(t){throw console.error("Error fetching packages with tag:",t),t}}static async fetchFilterMetadata(){console.log("📊 Fetching filter metadata...");const e=performance.now();try{console.log("📊 Starting parallel metadata queries...");const[t,r,s,i]=await Promise.all([this.fetchUniqueTags(),this.fetchUniqueLicenses(),this.fetchFoldersAndCategories(),this.fetchDatasetStats()]),o=((performance.now()-e)/1e3).toFixed(2);return console.log(`📊 Metadata fetch completed in ${o}s`),{allAvailableTags:t,allAvailableLicenses:r,allAvailableFolders:s.folders,allAvailableCategories:s.categories,datasetMaxStars:i.maxStars||0,datasetMaxCitations:i.maxCitations||0,totalPackageCount:i.totalCount}}catch(t){throw console.error("❌ Error fetching filter metadata:",t),t}}static async fetchUniqueLicenses(){var s,i;const e="unique_licenses",t=this.getCachedData(e);if(t)return console.log("  📜 Licenses loaded from cache"),t;console.log("  📜 Fetching unique licenses...");const r=performance.now();try{const o=await b("packages").select("license").filter("license","not","is.null").execute();if(o.error)throw console.error("  ❌ Licenses query error:",o.error),o.error;const c=new Set;(s=o.data)==null||s.forEach(f=>{f.license&&f.license.trim()&&c.add(f.license.trim())});const l=Array.from(c).sort();return this.setCachedData(e,l),console.log(`  📜 Licenses query completed, processed ${((i=o.data)==null?void 0:i.length)||0} rows in ${((performance.now()-r)/1e3).toFixed(2)}s`),l}catch(o){throw console.error("  ❌ Failed to fetch licenses:",o),o}}static async fetchDatasetStats(){var t,r,s,i;console.log("  📊 Fetching dataset statistics...");const e=performance.now();try{console.log("    ⭐📚🔢 Fetching all stats in parallel...");const[o,c,l]=await Promise.all([b("packages").select("github_stars").filter("github_stars","not","is.null").orderBy("github_stars","desc").paginate(0,1).execute(),b("packages").select("citations").filter("citations","not","is.null").orderBy("citations","desc").paginate(0,1).execute(),b("packages").select("id").execute()]);if(o.error)throw console.error("    ❌ Max stars query error:",o.error),o.error;if(c.error)throw console.error("    ❌ Max citations query error:",c.error),c.error;if(l.error)throw console.error("    ❌ Count query error:",l.error),l.error;return console.log(`  📊 Stats queries completed in ${((performance.now()-e)/1e3).toFixed(2)}s`),{maxStars:((r=(t=o.data)==null?void 0:t[0])==null?void 0:r.github_stars)||null,maxCitations:((i=(s=c.data)==null?void 0:s[0])==null?void 0:i.citations)||null,totalCount:l.count||0}}catch(o){throw console.error("  ❌ Failed to fetch dataset stats:",o),o}}static applyTagFilters(e,t,r="OR"){if(t.length===0)return e;switch(r){case"OR":return e.select("*, package_tags!inner(tags!inner(name))").in("package_tags.tags.name",t);case"AND":return t.forEach(s=>{e=e.select("*, package_tags!inner(tags!inner(name))").eq("package_tags.tags.name",s)}),e;case"SINGLE":return e.select("*, package_tags!inner(tags!inner(name))").eq("package_tags.tags.name",t[0]);default:return e}}static async refreshFilterMetadata(){console.log("🔄 Refreshing filter metadata...");try{const e=await this.fetchFilterMetadata(),{useFilterStore:t}=await Y(async()=>{const{useFilterStore:r}=await import("./index-CwGLBZlN.js").then(s=>s.a$);return{useFilterStore:r}},__vite__mapDeps([0,1]));t.setState({allAvailableTags:e.allAvailableTags,allAvailableLicenses:e.allAvailableLicenses,allAvailableFolders:e.allAvailableFolders,allAvailableCategories:e.allAvailableCategories,datasetMaxStars:e.datasetMaxStars,datasetMaxCitations:e.datasetMaxCitations}),console.log("✅ Filter metadata refreshed successfully")}catch(e){throw console.error("❌ Error refreshing filter metadata:",e),e}}}y(K,"metadataCache",new Map),y(K,"CACHE_TTL",5*60*1e3);export{K as DataService};
