import{c as D,j as e,R as Le,O as Re,r as o,n as X,o as Ue,t as w,C as q,q as k,A as d,T as c,p as u,G as i,U as Y,F as S,a6 as A,S as E,M as p,a4 as Z,N as O,m as v,a3 as N,H as W,ao as Be,al as qe,I as Ye,af as Ve,ag as Ge,ah as Je,ai as me,aj as C,ak as Ke}from"./index-ByaDLX4Y.js";import{T as Qe,a as fe}from"./Tabs-DmxRZU3z.js";const je=D(e.jsx("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"}),"AddCircleOutline"),ye=D(e.jsx("path",{d:"m12 2-5.5 9h11zm0 3.84L13.93 9h-3.87zM17.5 13c-2.49 0-4.5 2.01-4.5 4.5s2.01 4.5 4.5 4.5 4.5-2.01 4.5-4.5-2.01-4.5-4.5-4.5m0 7c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5M3 21.5h8v-8H3zm2-6h4v4H5z"}),"CategoryOutlined"),Xe=D(e.jsx("path",{d:"M19 9h-4V3H9v6H5l7 7zM5 18v2h14v-2z"}),"FileDownload"),Ze=D(e.jsx("path",{d:"m9.17 6 2 2H20v10H4V6zM10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8z"}),"FolderOutlined"),et=D(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2m0 12H4V6h5.17l2 2H20zm-6.92-3.96L12.39 17 15 15.47 17.61 17l-.69-2.96 2.3-1.99-3.03-.26L15 9l-1.19 2.79-3.03.26z"}),"FolderSpecialOutlined"),rt=()=>{var pe;const{currentUser:be,loading:ve,isAdmin:_}=Le(),j=Re(),[$,Ce]=o.useState(0),[l,x]=o.useState({operation:"update",filterOptions:{folder:null,category:null,tags:[]},updateOptions:{folder:null,category:null,addTags:[],removeTags:[]}}),[s,L]=o.useState({newFolder:"",selectedFolder:"",newCategory:""}),[V,R]=o.useState(!1),[P,U]=o.useState(!1),[ee,T]=o.useState(null),[te,ae]=o.useState(null),[re,F]=o.useState(null),[se,le]=o.useState(null),[G,ne]=o.useState(!1),[ie,y]=o.useState(null),[oe,de]=o.useState(null),[I,J]=o.useState(null),[m,ce]=o.useState([]),[B,he]=o.useState(!1),[Fe,z]=o.useState(!1),{allAvailableTags:K,allAvailableFolders:f,allAvailableCategories:g}=X(Ue(t=>({allAvailableTags:t.allAvailableTags,allAvailableFolders:t.allAvailableFolders,allAvailableCategories:t.allAvailableCategories}))),we=l.filterOptions.folder&&g[l.filterOptions.folder]?g[l.filterOptions.folder]:[],ge=o.useCallback(async()=>{he(!0),z(!0),y(null);try{let t=w.from("packages").select("*");l.filterOptions.folder&&(t=t.eq("folder1",l.filterOptions.folder)),l.filterOptions.folder&&l.filterOptions.category&&(t=t.eq("category1",l.filterOptions.category)),l.filterOptions.tags.length>0&&l.filterOptions.tags.forEach(n=>{t=t.contains("tags",[n])});const{data:a,error:r}=await t;if(r)throw r;ce(a||[])}catch(t){console.error("Error fetching matching packages:",t),y(`Failed to load matching packages: ${t.message}`),ce([])}finally{he(!1)}},[l.filterOptions]),Oe=t=>{x(a=>({...a,operation:t.target.value})),z(!1)},Te=t=>{const a=t.target.value==="null"?null:t.target.value;x(r=>({...r,filterOptions:{...r.filterOptions,folder:a,category:null}})),z(!1)},ke=t=>{const a=t.target.value==="null"?null:t.target.value;x(r=>({...r,filterOptions:{...r.filterOptions,category:a}})),z(!1)},Se=(t,a)=>{x(r=>({...r,filterOptions:{...r.filterOptions,tags:a}})),z(!1)},Ae=t=>{const a=t.target.value==="null"?null:t.target.value;x(r=>({...r,updateOptions:{...r.updateOptions,folder:a,category:null}}))},Ee=t=>{const a=t.target.value==="null"?null:t.target.value;x(r=>({...r,updateOptions:{...r.updateOptions,category:a}}))},$e=(t,a)=>{x(r=>({...r,updateOptions:{...r.updateOptions,addTags:a}}))},Pe=(t,a)=>{x(r=>({...r,updateOptions:{...r.updateOptions,removeTags:a}}))},Ie=(t,a)=>{Ce(a)},ue=t=>{const{name:a,value:r}=t.target;L(n=>({...n,[a]:r}))},ze=t=>{L(a=>({...a,selectedFolder:t.target.value}))},He=async()=>{if(!_){T("You must be an admin to perform this operation.");return}if(!s.newFolder.trim()){T("Please enter a folder name.");return}R(!0),T(null),ae(null);try{if(f.includes(s.newFolder.trim())){T(`Folder "${s.newFolder.trim()}" already exists.`),R(!1);return}const{data:t,error:a}=await w.from("packages").select("folder1").eq("folder1",s.newFolder.trim()).limit(1);if(a)throw a;if(t&&t.length>0){T(`Folder "${s.newFolder.trim()}" already exists in the database.`),R(!1);return}const{error:r}=await w.from("packages").insert({package_name:`__folder_placeholder_${Date.now()}`,folder1:s.newFolder.trim(),description:`This is a placeholder entry to establish the folder "${s.newFolder.trim()}". This entry can be safely deleted once other packages use this folder.`});if(r)throw r;const n=[...f,s.newFolder.trim()].sort(),h={...g,[s.newFolder.trim()]:[]};L(b=>({...b,newFolder:""})),ae(`Folder "${s.newFolder.trim()}" has been created successfully.`),X.setState({allAvailableFolders:n,allAvailableCategories:h})}catch(t){console.error("Error creating folder:",t),T(`Failed to create folder: ${t.message}`)}finally{R(!1)}},Me=async()=>{var t;if(!_){F("You must be an admin to perform this operation.");return}if(!s.selectedFolder){F("Please select a folder.");return}if(!s.newCategory.trim()){F("Please enter a category name.");return}U(!0),F(null),le(null);try{if((t=g[s.selectedFolder])!=null&&t.includes(s.newCategory.trim())){F(`Category "${s.newCategory.trim()}" already exists in this folder.`),U(!1);return}const{data:a,error:r}=await w.from("packages").select("category1").eq("folder1",s.selectedFolder).eq("category1",s.newCategory.trim()).limit(1);if(r)throw r;if(a&&a.length>0){F(`Category "${s.newCategory.trim()}" already exists in this folder.`),U(!1);return}const{error:n}=await w.from("packages").insert({package_name:`__category_placeholder_${Date.now()}`,folder1:s.selectedFolder,category1:s.newCategory.trim(),description:`This is a placeholder entry to establish the category "${s.newCategory.trim()}" in folder "${s.selectedFolder}". This entry can be safely deleted once other packages use this category.`});if(n)throw n;const h={...g,[s.selectedFolder]:[...g[s.selectedFolder]||[],s.newCategory.trim()].sort()};L(b=>({...b,newCategory:""})),le(`Category "${s.newCategory.trim()}" has been created successfully in folder "${s.selectedFolder}".`),X.setState({allAvailableCategories:h})}catch(a){console.error("Error creating category:",a),F(`Failed to create category: ${a.message}`)}finally{U(!1)}},Ne=async()=>{if(!_){y("You must be an admin to perform this operation.");return}if(m.length===0){y("No packages match the current filter criteria.");return}if(!(l.updateOptions.folder!==null||l.updateOptions.category!==null||l.updateOptions.addTags.length>0||l.updateOptions.removeTags.length>0)){y("Please specify at least one update option.");return}ne(!0),y(null),de(null),J(null);try{const a=m.map(h=>h.id);let r=0,n=0;for(const h of a)try{const{data:b,error:xe}=await w.from("packages").select("*").eq("id",h).single();if(xe)throw xe;if(!b)continue;const H={};if(l.updateOptions.folder!==null&&(H.folder1=l.updateOptions.folder),l.updateOptions.category!==null&&(H.category1=l.updateOptions.category),l.updateOptions.addTags.length>0||l.updateOptions.removeTags.length>0){const M=b.tags||[],De=l.updateOptions.addTags.filter(Q=>!M.includes(Q)),_e=M.filter(Q=>!l.updateOptions.removeTags.includes(Q));H.tags=[..._e,...De]}if(Object.keys(H).length>0){const{error:M}=await w.from("packages").update(H).eq("id",h);if(M)throw M;r++}}catch(b){console.error("Error updating package:",b),n++}J({status:n>0?r>0?"warning":"error":"success",message:`Operation completed with ${r} packages updated successfully${n>0?` and ${n} errors`:""}.`,affectedPackages:r}),de(`Successfully updated ${r} packages.`),n>0&&y(`Failed to update ${n} packages.`),await ge()}catch(a){console.error("Error executing bulk operation:",a),y(`Failed to execute operation: ${a.message}`),J({status:"error",message:`Operation failed: ${a.message}`,affectedPackages:0})}finally{ne(!1)}},We=()=>{if(m.length===0)return;const t=JSON.stringify(m,null,2),a="data:application/json;charset=utf-8,"+encodeURIComponent(t),r=`cadd-vault-packages-${new Date().toISOString()}.json`,n=document.createElement("a");n.setAttribute("href",a),n.setAttribute("download",r),n.click()};return ve?e.jsx(q,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"80vh"},children:e.jsx(k,{})}):be?_?e.jsxs(q,{sx:{py:4},children:[e.jsx(c,{variant:"h4",component:"h1",gutterBottom:!0,sx:{fontWeight:"bold"},children:"Database Administration"}),e.jsx(c,{variant:"subtitle1",color:"text.secondary",gutterBottom:!0,children:"Manage database entries and structure."}),e.jsx(u,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:e.jsxs(Qe,{value:$,onChange:Ie,"aria-label":"admin operations tabs",children:[e.jsx(fe,{label:"Bulk Updates",id:"admin-tab-0","aria-controls":"admin-tabpanel-0"}),e.jsx(fe,{label:"Folder & Category Management",id:"admin-tab-1","aria-controls":"admin-tabpanel-1"})]})}),e.jsx("div",{role:"tabpanel",hidden:$!==0,id:"admin-tabpanel-0","aria-labelledby":"admin-tab-0",children:$===0&&e.jsxs(i,{container:!0,spacing:3,children:[e.jsx(i,{item:!0,xs:12,children:e.jsxs(Y,{elevation:3,sx:{p:3,mt:2},children:[e.jsx(c,{variant:"h6",gutterBottom:!0,children:"Operation Settings"}),e.jsxs(S,{fullWidth:!0,sx:{mb:3},children:[e.jsx(A,{children:"Operation Type"}),e.jsx(E,{value:l.operation,onChange:Oe,label:"Operation Type",children:e.jsx(p,{value:"update",children:"Update Packages"})})]}),e.jsxs(u,{sx:{mb:4},children:[e.jsxs(c,{variant:"subtitle1",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(Ze,{sx:{mr:1}}),"Filter Criteria"]}),e.jsx(d,{severity:"info",sx:{mb:2},children:"Define which packages will be affected by this operation."}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(S,{fullWidth:!0,children:[e.jsx(A,{children:"Folder"}),e.jsxs(E,{value:l.filterOptions.folder||"null",onChange:Te,label:"Folder",children:[e.jsx(p,{value:"null",children:"Any Folder"}),f.map(t=>e.jsx(p,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(S,{fullWidth:!0,disabled:!l.filterOptions.folder,children:[e.jsx(A,{children:"Category"}),e.jsxs(E,{value:l.filterOptions.category||"null",onChange:ke,label:"Category",children:[e.jsx(p,{value:"null",children:"Any Category"}),we.map(t=>e.jsx(p,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(Z,{multiple:!0,id:"filter-tags",options:K,value:l.filterOptions.tags,onChange:Se,renderInput:t=>e.jsx(N,{...t,label:"Has Tags",placeholder:"Select tags to filter by",helperText:"Only packages having ALL selected tags will be affected"}),renderTags:(t,a)=>t.map((r,n)=>e.jsx(O,{variant:"outlined",label:r,...a({index:n}),sx:{bgcolor:v(j.palette.primary.main,.1),borderColor:v(j.palette.primary.main,.3)}}))})})]})]}),e.jsx(W,{variant:"outlined",color:"primary",onClick:ge,disabled:B,sx:{mb:4},children:B?e.jsx(k,{size:24}):"Preview Matching Packages"}),e.jsx(Be,{sx:{mb:4}}),e.jsxs(u,{sx:{mb:4},children:[e.jsxs(c,{variant:"subtitle1",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(ye,{sx:{mr:1}}),"Update Options"]}),e.jsx(d,{severity:"warning",sx:{mb:2},children:"Specify the changes to apply to all matching packages."}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(S,{fullWidth:!0,children:[e.jsx(A,{children:"Change Folder To"}),e.jsxs(E,{value:l.updateOptions.folder||"null",onChange:Ae,label:"Change Folder To",children:[e.jsx(p,{value:"null",children:"No Change"}),f.map(t=>e.jsx(p,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(S,{fullWidth:!0,children:[e.jsx(A,{children:"Change Category To"}),e.jsxs(E,{value:l.updateOptions.category||"null",onChange:Ee,label:"Change Category To",children:[e.jsx(p,{value:"null",children:"No Change"}),Object.values(g).flat().filter((t,a,r)=>r.indexOf(t)===a).sort().map(t=>e.jsx(p,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(Z,{multiple:!0,id:"add-tags",options:K.filter(t=>!l.updateOptions.addTags.includes(t)),value:l.updateOptions.addTags,onChange:$e,renderInput:t=>e.jsx(N,{...t,label:"Add Tags",placeholder:"Select tags to add",helperText:"These tags will be added to all matching packages"}),renderTags:(t,a)=>t.map((r,n)=>e.jsx(O,{variant:"outlined",label:r,...a({index:n}),sx:{bgcolor:v(j.palette.success.main,.1),borderColor:v(j.palette.success.main,.3)}}))})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(Z,{multiple:!0,id:"remove-tags",options:K.filter(t=>!l.updateOptions.removeTags.includes(t)),value:l.updateOptions.removeTags,onChange:Pe,renderInput:t=>e.jsx(N,{...t,label:"Remove Tags",placeholder:"Select tags to remove",helperText:"These tags will be removed from all matching packages"}),renderTags:(t,a)=>t.map((r,n)=>e.jsx(O,{variant:"outlined",label:r,...a({index:n}),sx:{bgcolor:v(j.palette.error.main,.1),borderColor:v(j.palette.error.main,.3)}}))})})]})]}),ie&&e.jsx(d,{severity:"error",sx:{mb:2},children:ie}),oe&&e.jsx(d,{severity:"success",sx:{mb:2},children:oe}),I&&e.jsxs(d,{severity:I.status,sx:{mb:2},children:[I.message,I.details&&e.jsx(c,{variant:"body2",mt:1,children:I.details})]}),e.jsx(W,{variant:"contained",color:"primary",disabled:G||m.length===0,onClick:Ne,sx:{mr:2},children:G?e.jsx(k,{size:24}):"Execute Operation"}),e.jsx(W,{variant:"outlined",color:"secondary",onClick:()=>x({operation:"update",filterOptions:{folder:null,category:null,tags:[]},updateOptions:{folder:null,category:null,addTags:[],removeTags:[]}}),disabled:G,children:"Reset Form"})]})}),Fe&&e.jsx(i,{item:!0,xs:12,children:e.jsxs(Y,{elevation:3,sx:{p:3,mt:2},children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(c,{variant:"h6",children:B?"Loading Matching Packages...":`Matching Packages (${m.length})`}),m.length>0&&e.jsx(qe,{title:"Download as JSON",children:e.jsx(Ye,{onClick:We,color:"primary",children:e.jsx(Xe,{})})})]}),B?e.jsx(u,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(k,{})}):m.length===0?e.jsx(d,{severity:"info",children:"No packages match the selected filter criteria."}):e.jsx(Ve,{sx:{maxHeight:400},children:e.jsxs(Ge,{stickyHeader:!0,children:[e.jsx(Je,{children:e.jsxs(me,{children:[e.jsx(C,{sx:{fontWeight:"bold"},children:"Package Name"}),e.jsx(C,{sx:{fontWeight:"bold"},children:"Folder"}),e.jsx(C,{sx:{fontWeight:"bold"},children:"Category"}),e.jsx(C,{sx:{fontWeight:"bold"},children:"Tags"})]})}),e.jsx(Ke,{children:m.map(t=>{var a,r,n;return e.jsxs(me,{hover:!0,children:[e.jsx(C,{children:t.package_name}),e.jsx(C,{children:t.folder1||"—"}),e.jsx(C,{children:t.category1||"—"}),e.jsx(C,{children:e.jsxs(u,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:[(a=t.tags)==null?void 0:a.slice(0,5).map(h=>e.jsx(O,{label:h,size:"small",sx:{fontSize:"0.75rem",height:22}},h)),(((r=t.tags)==null?void 0:r.length)||0)>5&&e.jsx(O,{label:`+${(((n=t.tags)==null?void 0:n.length)||0)-5} more`,size:"small",variant:"outlined",sx:{fontSize:"0.75rem",height:22}}),(!t.tags||t.tags.length===0)&&e.jsx(c,{variant:"body2",color:"text.secondary",children:"No tags"})]})})]},t.id)})})]})})]})})]})}),e.jsx("div",{role:"tabpanel",hidden:$!==1,id:"admin-tabpanel-1","aria-labelledby":"admin-tab-1",children:$===1&&e.jsxs(i,{container:!0,spacing:3,children:[e.jsx(i,{item:!0,xs:12,md:6,children:e.jsxs(Y,{elevation:3,sx:{p:3},children:[e.jsxs(c,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(et,{sx:{mr:1}}),"Create New Folder"]}),e.jsx(d,{severity:"info",sx:{mb:3},children:"Add a new top-level folder to organize packages. Folders are the main classification groups."}),ee&&e.jsx(d,{severity:"error",sx:{mb:2},children:ee}),te&&e.jsx(d,{severity:"success",sx:{mb:2},children:te}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"New Folder Name",name:"newFolder",value:s.newFolder,onChange:ue,placeholder:"Enter folder name",helperText:"This will create a new folder in the database"})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(W,{variant:"contained",color:"primary",onClick:He,disabled:V||!s.newFolder.trim(),startIcon:V?e.jsx(k,{size:20}):e.jsx(je,{}),fullWidth:!0,children:V?"Creating...":"Create Folder"})})]}),e.jsxs(c,{variant:"subtitle2",sx:{mt:3,mb:1},children:["Existing Folders (",f.length,")"]}),e.jsx(u,{sx:{maxHeight:200,overflowY:"auto",border:1,borderColor:"divider",borderRadius:1,p:1},children:f.length>0?e.jsx(u,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:f.map(t=>e.jsx(O,{label:t,variant:"outlined",size:"small",sx:{bgcolor:v(j.palette.primary.main,.05)}},t))}):e.jsx(c,{variant:"body2",color:"text.secondary",children:"No folders defined yet."})})]})}),e.jsx(i,{item:!0,xs:12,md:6,children:e.jsxs(Y,{elevation:3,sx:{p:3},children:[e.jsxs(c,{variant:"h6",sx:{mb:2,display:"flex",alignItems:"center"},children:[e.jsx(ye,{sx:{mr:1}}),"Create New Category"]}),e.jsx(d,{severity:"info",sx:{mb:3},children:"Add a new category within an existing folder. Categories are subgroups of folders."}),re&&e.jsx(d,{severity:"error",sx:{mb:2},children:re}),se&&e.jsx(d,{severity:"success",sx:{mb:2},children:se}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:12,children:e.jsxs(S,{fullWidth:!0,children:[e.jsx(A,{children:"Select Folder"}),e.jsx(E,{value:s.selectedFolder,onChange:ze,label:"Select Folder",disabled:P||f.length===0,children:f.map(t=>e.jsx(p,{value:t,children:t},t))})]})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(N,{fullWidth:!0,label:"New Category Name",name:"newCategory",value:s.newCategory,onChange:ue,placeholder:"Enter category name",helperText:"This will create a new category within the selected folder",disabled:!s.selectedFolder||P})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(W,{variant:"contained",color:"primary",onClick:Me,disabled:P||!s.selectedFolder||!s.newCategory.trim(),startIcon:P?e.jsx(k,{size:20}):e.jsx(je,{}),fullWidth:!0,children:P?"Creating...":"Create Category"})})]}),s.selectedFolder&&e.jsxs(e.Fragment,{children:[e.jsxs(c,{variant:"subtitle2",sx:{mt:3,mb:1},children:['Existing Categories in "',s.selectedFolder,'" (',(g[s.selectedFolder]||[]).length,")"]}),e.jsx(u,{sx:{maxHeight:200,overflowY:"auto",border:1,borderColor:"divider",borderRadius:1,p:1},children:((pe=g[s.selectedFolder])==null?void 0:pe.length)>0?e.jsx(u,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:g[s.selectedFolder].map(t=>e.jsx(O,{label:t,variant:"outlined",size:"small",sx:{bgcolor:v(j.palette.secondary.main,.05)}},t))}):e.jsx(c,{variant:"body2",color:"text.secondary",children:"No categories defined in this folder yet."})})]})]})})]})})]}):e.jsx(q,{sx:{py:4},children:e.jsx(d,{severity:"error",children:"Access Denied. This page is for administrators only."})}):e.jsx(q,{sx:{py:4},children:e.jsx(d,{severity:"error",children:"You must be logged in to access this page."})})};export{rt as default};
