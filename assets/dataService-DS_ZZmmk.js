const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BuzR7-x9.js","assets/index-B7rZpWz0.css"])))=>i.map(i=>d[i]);
import{a2 as d,v as U}from"./index-BuzR7-x9.js";class j{static async fetchPackages(r){const{searchTerm:e,selectedTags:o=[],minStars:a=null,hasGithub:c,hasWebserver:s,hasPublication:i,minCitations:f=null,minRating:l=null,folder1:u=null,category1:_=null,selectedLicenses:k=[],sortBy:y="package_name",sortDirection:F="asc",page:b=1,pageSize:x=50,includeUserRatings:C=!1,currentUserId:S=null}=r;try{let t=d.from("packages").select(`
                    *,
                    package_tags!left(
                        tag_id,
                        tags!inner(id, name)
                    ),
                    package_folder_categories!left(
                        folder_category_id,
                        folder_categories!inner(
                            id,
                            folder_id,
                            category_id,
                            folders!inner(id, name),
                            categories!inner(id, name)
                        )
                    )
                `,{count:"exact"});if(e&&(t=t.or(`package_name.ilike.%${e}%,description.ilike.%${e}%`)),o.length>0){const{data:g}=await d.from("tags").select("id, name").in("name",o);if(g&&g.length>0){const m=g.map(n=>n.id);for(const n of m){const{data:h}=await d.from("package_tags").select("package_id").eq("tag_id",n);if(h&&h.length>0){const p=h.map(w=>w.package_id);t=t.in("id",p)}else t=t.eq("id","00000000-0000-0000-0000-000000000000")}}}if(u||_){let g=d.from("folder_categories").select("id");if(u){const{data:n}=await d.from("folders").select("id").eq("name",u).single();n&&(g=g.eq("folder_id",n.id))}if(_){const{data:n}=await d.from("categories").select("id").eq("name",_).single();n&&(g=g.eq("category_id",n.id))}const{data:m}=await g;if(m&&m.length>0){const n=m.map(p=>p.id),{data:h}=await d.from("package_folder_categories").select("package_id").in("folder_category_id",n);if(h&&h.length>0){const p=h.map(w=>w.package_id);t=t.in("id",p)}else t=t.eq("id","00000000-0000-0000-0000-000000000000")}}a!==null&&(t=t.gte("github_stars",a)),c===!0&&(t=t.not("repo_link","is",null)),s===!0&&(t=t.not("webserver","is",null)),i===!0&&(t=t.not("publication","is",null)),f!==null&&(t=t.gte("citations",f)),l!==null&&(t=t.gte("average_rating",l)),k.length>0&&(t=t.in("license",k)),y&&(t=t.order(y,{ascending:F==="asc"}));const q=(b-1)*x,R=q+x-1;t=t.range(q,R);const{data:$,error:v,count:P}=await t;if(v)throw v;const A=($||[]).map(g=>{var m,n,h,p,w,E,M,I,D;return{...g,tags:((m=g.package_tags)==null?void 0:m.map(O=>{var L;return(L=O.tags)==null?void 0:L.name}).filter(Boolean))||[],folder1:((w=(p=(h=(n=g.package_folder_categories)==null?void 0:n[0])==null?void 0:h.folder_categories)==null?void 0:p.folders)==null?void 0:w.name)||"",category1:((D=(I=(M=(E=g.package_folder_categories)==null?void 0:E[0])==null?void 0:M.folder_categories)==null?void 0:I.categories)==null?void 0:D.name)||""}});let T;if(C&&S){const g=A.map(n=>n.id),{data:m}=await d.from("ratings").select("package_id, rating, id").eq("user_id",S).in("package_id",g);m&&(T=new Map(m.map(n=>[n.package_id,{rating:n.rating,rating_id:n.id}])))}return{packages:A,totalCount:P||0,userRatings:T}}catch(t){throw console.error("Error fetching packages:",t),t}}static async fetchUniqueTags(){console.log("  üìå Fetching unique tags...");const r=performance.now();try{const{data:e,error:o}=await d.from("tags").select("name").order("name");if(o)throw o;return console.log(`  üìå Tags query completed in ${((performance.now()-r)/1e3).toFixed(2)}s`),(e==null?void 0:e.map(a=>a.name))||[]}catch(e){throw console.error("  ‚ùå Failed to fetch tags:",e),e}}static async fetchFoldersAndCategories(){console.log("  üìÅ Fetching folders and categories...");const r=performance.now();try{const{data:e,error:o}=await d.from("folder_categories").select(`
                    folders!inner(name),
                    categories!inner(name)
                `).order("folders(name), categories(name)");if(o)throw o;const a={};e==null||e.forEach(s=>{var l,u;const i=(l=s.folders)==null?void 0:l.name,f=(u=s.categories)==null?void 0:u.name;i&&f&&(a[i]||(a[i]=[]),a[i].includes(f)||a[i].push(f))}),Object.keys(a).forEach(s=>{a[s].sort()});const c=Object.keys(a).sort();return console.log(`  üìÅ Folders/Categories fetched in ${((performance.now()-r)/1e3).toFixed(2)}s`),{folders:c,categories:a}}catch(e){throw console.error("  ‚ùå Failed to fetch folders/categories:",e),e}}static async fetchPackagesWithTag(r){try{const{data:e,error:o}=await d.from("tags").select("id").eq("name",r.trim()).single();if(o||!e)return[];const{data:a,error:c}=await d.from("packages").select(`
                    *,
                    package_tags!inner(tag_id),
                    package_tags!left(
                        tags!inner(id, name)
                    ),
                    package_folder_categories!left(
                        folder_categories!inner(
                            folders!inner(name),
                            categories!inner(name)
                        )
                    )
                `).eq("package_tags.tag_id",e.id);if(c)throw c;return(a||[]).map(s=>{var i,f,l,u,_,k,y,F,b;return{...s,tags:((i=s.package_tags)==null?void 0:i.map(x=>{var C;return(C=x.tags)==null?void 0:C.name}).filter(Boolean))||[],folder1:((_=(u=(l=(f=s.package_folder_categories)==null?void 0:f[0])==null?void 0:l.folder_categories)==null?void 0:u.folders)==null?void 0:_.name)||"",category1:((b=(F=(y=(k=s.package_folder_categories)==null?void 0:k[0])==null?void 0:y.folder_categories)==null?void 0:F.categories)==null?void 0:b.name)||""}})}catch(e){throw console.error("Error fetching packages with tag:",e),e}}static async fetchFilterMetadata(){console.log("üìä Fetching filter metadata...");const r=performance.now();try{console.log("üìä Starting parallel metadata queries...");const[e,o,a,c]=await Promise.all([this.fetchUniqueTags(),this.fetchUniqueLicenses(),this.fetchFoldersAndCategories(),this.fetchDatasetStats()]),s=((performance.now()-r)/1e3).toFixed(2);return console.log(`üìä Metadata fetch completed in ${s}s`),{allAvailableTags:e,allAvailableLicenses:o,allAvailableFolders:a.folders,allAvailableCategories:a.categories,datasetMaxStars:c.maxStars||0,datasetMaxCitations:c.maxCitations||0,totalPackageCount:c.totalCount}}catch(e){throw console.error("‚ùå Error fetching filter metadata:",e),e}}static async fetchUniqueLicenses(){console.log("  üìú Fetching unique licenses...");const r=performance.now();try{const e=new Set;let o=0;const a=1e3;let c=!0,s=0;for(;c;){const{data:i,error:f}=await d.from("packages").select("license").not("license","is",null).range(o,o+a-1);if(f)throw console.error("  ‚ùå Licenses query error:",f),f;if(!i||i.length===0){c=!1;break}i.forEach(l=>{l.license&&l.license.trim()&&e.add(l.license.trim())}),s+=i.length,c=i.length===a,o+=a}return console.log(`  üìú Licenses query completed, processed ${s} total rows in ${((performance.now()-r)/1e3).toFixed(2)}s`),Array.from(e).sort()}catch(e){throw console.error("  ‚ùå Failed to fetch licenses:",e),e}}static async fetchDatasetStats(){var e,o;console.log("  üìä Fetching dataset statistics...");const r=performance.now();try{console.log("    ‚≠ê Fetching max stars...");const{data:a,error:c}=await d.from("packages").select("github_stars").not("github_stars","is",null).order("github_stars",{ascending:!1}).limit(1);if(c)throw console.error("    ‚ùå Max stars query error:",c),c;console.log("    üìö Fetching max citations...");const{data:s,error:i}=await d.from("packages").select("citations").not("citations","is",null).order("citations",{ascending:!1}).limit(1);if(i)throw console.error("    ‚ùå Max citations query error:",i),i;console.log("    üî¢ Fetching total count...");const{count:f,error:l}=await d.from("packages").select("*",{count:"exact",head:!0});if(l)throw console.error("    ‚ùå Count query error:",l),l;return console.log(`  üìä Stats queries completed in ${((performance.now()-r)/1e3).toFixed(2)}s`),{maxStars:((e=a==null?void 0:a[0])==null?void 0:e.github_stars)||null,maxCitations:((o=s==null?void 0:s[0])==null?void 0:o.citations)||null,totalCount:f||0}}catch(a){throw console.error("  ‚ùå Failed to fetch dataset stats:",a),a}}static applyTagFilters(r,e,o="OR"){if(e.length===0)return r;switch(o){case"OR":return r.filter("tags","cs",JSON.stringify(e));case"AND":return e.forEach(a=>{r=r.contains("tags",[a])}),r;case"SINGLE":return r.contains("tags",[e[0]]);default:return r}}static async refreshFilterMetadata(){console.log("üîÑ Refreshing filter metadata...");try{const r=await this.fetchFilterMetadata(),{useFilterStore:e}=await U(async()=>{const{useFilterStore:o}=await import("./index-BuzR7-x9.js").then(a=>a.aI);return{useFilterStore:o}},__vite__mapDeps([0,1]));e.setState({allAvailableTags:r.allAvailableTags,allAvailableLicenses:r.allAvailableLicenses,allAvailableFolders:r.allAvailableFolders,allAvailableCategories:r.allAvailableCategories,datasetMaxStars:r.datasetMaxStars,datasetMaxCitations:r.datasetMaxCitations}),console.log("‚úÖ Filter metadata refreshed successfully")}catch(r){throw console.error("‚ùå Error refreshing filter metadata:",r),r}}}export{j as DataService};
