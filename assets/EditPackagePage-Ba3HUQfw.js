import{Q as X,R as Z,o as ee,r as s,n as m,j as e,t as ae,v as E,T as k,U as re,ae as u,F as q,af as N,S as B,M as C,ag as te,ah as ne,N as le,H as G}from"./index-B7UqGdPd.js";import{G as i}from"./Grid-Bq28EWbL.js";const ie=()=>{const{packageId:I}=X(),c=I?decodeURIComponent(I):void 0,b=Z(),{isAdmin:o,loading:w}=ee(),[a,p]=s.useState({}),[f,$]=s.useState(!1),[h,y]=s.useState(!1),[x,v]=s.useState(null),[H,z]=s.useState([]),[S,P]=s.useState(!1),[M,O]=s.useState([]),[Q,A]=s.useState([]),F=s.useCallback(async()=>{var t,r,l,n,j,_,T,R,W;if(!(!c||!o)){y(!0),v(null);try{const{data:d,error:D}=await m.from("packages").select(`
                *,
                package_tags!left(
                    tags!inner(name)
                ),
                package_folder_categories!left(
                    folder_categories!inner(
                        folders!inner(name),
                        categories!inner(name)
                    )
                )
            `).eq("id",c).single();if(D)throw D;if(d){const K={...d,tags:((t=d.package_tags)==null?void 0:t.map(V=>{var U;return(U=V.tags)==null?void 0:U.name}).filter(Boolean))||[],folder1:((j=(n=(l=(r=d.package_folder_categories)==null?void 0:r[0])==null?void 0:l.folder_categories)==null?void 0:n.folders)==null?void 0:j.name)||"",category1:((W=(R=(T=(_=d.package_folder_categories)==null?void 0:_[0])==null?void 0:T.folder_categories)==null?void 0:R.categories)==null?void 0:W.name)||""};p(K),$(!0)}}catch(d){console.error("Error fetching package:",d),v(`Failed to load package data: ${d.message}`)}finally{y(!1)}}},[c,o]);s.useEffect(()=>{if(!w&&!o){console.warn("Access denied: User is not an admin."),b("/");return}o&&c&&!f&&F()},[o,w,b,c,f,F]),s.useEffect(()=>{o&&(async()=>{if(o){P(!0);try{const{data:r,error:l}=await m.from("tags").select("name").order("name");if(l)throw l;z((r==null?void 0:r.map(n=>n.name))||[])}catch(r){console.error("Error fetching tags:",r)}finally{P(!1)}}})()},[o]),s.useEffect(()=>{o&&(async()=>{if(o)try{const{data:r,error:l}=await m.from("folders").select("name").order("name");if(l)throw l;if(O((r==null?void 0:r.map(n=>n.name))||[]),a.folder1){const{data:n,error:j}=await m.from("folder_categories").select(`
							categories!inner(name),
							folders!inner(name)
						`).eq("folders.name",a.folder1);if(j)throw j;A((n==null?void 0:n.map(_=>_.categories.name))||[])}}catch(r){console.error("Error fetching folders/categories:",r)}})()},[o,a.folder1]);const g=t=>{const{name:r,value:l}=t.target;p(n=>({...n,[r]:l}))},Y=(t,r)=>{p(l=>({...l,tags:r}))},L=t=>{const{name:r,value:l}=t.target;p(n=>({...n,[r]:l})),r==="folder1"&&(p(n=>({...n,category1:""})),A([]))},J=async t=>{if(t.preventDefault(),v(null),!c||!a.package_name){v("Package ID and name are required.");return}y(!0);try{const{error:r}=await m.from("packages").update({package_name:a.package_name,description:a.description||null,publication:a.publication||null,webserver:a.webserver||null,repo_link:a.repo_link||null,link:a.link||null,license:a.license||null,last_updated:new Date().toISOString(),tags:a.tags||[],folder1:a.folder1||null,category1:a.category1||null}).eq("id",c);if(r)throw r;const{error:l}=await m.rpc("update_package_tags",{package_uuid:c,new_tags:a.tags||[]});l&&console.error("Error updating tags:",l);const{error:n}=await m.rpc("update_package_folder_category",{package_uuid:c,folder_name:a.folder1||"",category_name:a.category1||""});n&&console.error("Error updating folder/category:",n),b(`/package/${encodeURIComponent(c)}`)}catch(r){console.error("Error updating package:",r),v(`Failed to update package: ${r.message}`)}finally{y(!1)}};return w||o&&!f&&!x?e.jsx(ae,{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh",children:e.jsx(E,{})}):o?x&&!f?e.jsx(k,{color:"error",align:"center",children:x}):o&&!f?e.jsx(k,{color:"error",align:"center",children:"Could not load package data."}):e.jsxs(re,{elevation:3,sx:{p:3,m:2},children:[e.jsxs(k,{variant:"h4",gutterBottom:!0,component:"div",children:["Edit Package: ",a.package_name||"..."]}),e.jsx("form",{onSubmit:J,children:e.jsxs(i,{container:!0,spacing:3,children:[e.jsx(i,{item:!0,xs:12,children:e.jsx(u,{id:"package_name",label:"Package Name (package_name)",name:"package_name",value:a.package_name||"",onChange:g,required:!0,fullWidth:!0,variant:"outlined"})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(u,{id:"description",label:"Description",name:"description",value:a.description||"",onChange:g,multiline:!0,rows:4,fullWidth:!0,variant:"outlined"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"publication",label:"Publication URL",name:"publication",value:a.publication||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"webserver",label:"Webserver/Homepage URL",name:"webserver",value:a.webserver||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"repo_link",label:"Code Repository Link (GitHub or other)",name:"repo_link",value:a.repo_link||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url",helperText:"Enter the URL for the code repository"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"link",label:"General Link",name:"link",value:a.link||"",onChange:g,fullWidth:!0,variant:"outlined",type:"url",helperText:"Any other relevant link (not publication or webserver)"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsx(u,{id:"license",label:"License",name:"license",value:a.license||"",onChange:g,fullWidth:!0,variant:"outlined"})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(q,{fullWidth:!0,variant:"outlined",children:[e.jsx(N,{id:"folder1-label",children:"Folder"}),e.jsxs(B,{labelId:"folder1-label",id:"folder1",name:"folder1",value:a.folder1||"",onChange:L,label:"Folder",children:[e.jsx(C,{value:"",children:e.jsx("em",{children:"None"})}),M.map(t=>e.jsx(C,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,sm:6,children:e.jsxs(q,{fullWidth:!0,variant:"outlined",children:[e.jsx(N,{id:"category1-label",children:"Category"}),e.jsxs(B,{labelId:"category1-label",id:"category1",name:"category1",value:a.category1||"",onChange:L,label:"Category",disabled:!a.folder1,children:[e.jsx(C,{value:"",children:e.jsx("em",{children:"None"})}),Q.map(t=>e.jsx(C,{value:t,children:t},t))]})]})}),e.jsx(i,{item:!0,xs:12,children:e.jsx(te,{multiple:!0,id:"tags-filled",options:H,loading:S,value:a.tags||[],onChange:Y,freeSolo:!0,renderTags:(t,r)=>t.map((l,n)=>e.jsx(le,{variant:"outlined",label:l,...r({index:n})})),renderInput:t=>e.jsx(u,{...t,id:"tags-input",name:"tags",variant:"outlined",label:"Tags",placeholder:"Add or select tags",InputProps:{...t.InputProps,endAdornment:e.jsxs(ne.Fragment,{children:[S?e.jsx(E,{color:"inherit",size:20}):null,t.InputProps.endAdornment]})}})})}),e.jsxs(i,{item:!0,xs:12,children:[x&&!h&&e.jsx(k,{color:"error",sx:{mb:2},children:x}),e.jsx(G,{type:"submit",variant:"contained",color:"primary",disabled:h,startIcon:h?e.jsx(E,{size:20}):null,children:h?"Saving...":"Save Changes"}),e.jsx(G,{variant:"outlined",color:"secondary",onClick:()=>b(`/package/${encodeURIComponent(c||"")}`),sx:{ml:2},disabled:h,children:"Cancel"})]})]})})]}):e.jsx(k,{color:"error",align:"center",children:"Access Denied. You must be an admin to edit packages."})};export{ie as default};
